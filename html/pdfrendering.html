<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book</title>
    <link rel="icon" type="image/x-icon" href="/download.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            overflow-y: hidden;
        }

        .top-bar {
            background-color: hsla(246, 97%, 7%, 0.83);
            color: #ffffff;
            padding: 0.37rem;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 10;
        }

        .page-info {
            margin-left: 1rem;
        }

        .error {
            background: orangered;
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .center-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100dvh;
            padding-top: 3rem;
            /* Account for fixed top-bar */
            box-sizing: border-box;
            background-image: linear-gradient(hsla(246, 97%, 7%, 0.83), hsla(279, 97%, 9%, 0.83));
        }

        #the-canvas {
            height: calc(100% - 3rem);
            /* Adjust height for top-bar */
            width: 90%;
            object-fit: contain;
        }

        .loader {
            border: 0.7rem solid #f3f3f3;
            border-top: 0.7rem solid #3498db;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            animation: spin 3s linear infinite;
            display: none;
            position: absolute;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-message {
            font-size: 1rem;
            color: #ff9800;
            font-style: italic;
            font-weight: bold;
            text-align: center;
            position: absolute;
            bottom: 5%;
        }
    </style>
</head>

<body>
    <div class="top-bar">
        <span class="page-info">
            Page <span id="page-num" contenteditable="true"></span> of <span id="page-count"></span>
        </span>
    </div>

    <div class="center-container">
        <canvas id="the-canvas"></canvas>
        <div class="loader" id="loader"></div>
    </div>

    <script src="/js/pdf.min.js"></script>
    <script src="/js/pdf.worker.min.js"></script>
    <script src="/js/pdf-lib.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            let isEditing = false;

            const urlParams = new URLSearchParams(window.location.search);
            const filename = urlParams.get('filename');
            const dirParam = urlParams.get('dir'); // Used for generic multi-part PDFs

            let pdfDoc = null, pageNum = 1, pageIsRendering = false, pageNumIsPending = null;
            const scale = 5,
                canvas = document.getElementById('the-canvas'),
                context = canvas.getContext('2d');
            const loader = document.getElementById('loader');

            loader.style.display = 'block';
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'loading-message';
            document.querySelector('.center-container').appendChild(loadingMessage);

            const renderPage = (num) => {
                pageIsRendering = true;
                if (!pdfDoc) return;
                pdfDoc.getPage(num).then((page) => {
                    const viewport = page.getViewport({ scale });
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    const renderContext = { canvasContext: context, viewport: viewport };
                    page.render(renderContext).promise.then(() => {
                        pageIsRendering = false;
                        if (pageNumIsPending !== null) {
                            renderPage(pageNumIsPending);
                            pageNumIsPending = null;
                        }
                        document.getElementById('page-num').textContent = displayPageNumber(num);
                    });
                });
            };

            const queueRenderPage = (num) => {
                if (pageIsRendering) { pageNumIsPending = num; }
                else { renderPage(num); }
            };

            const updateAndRenderPage = (newPageNum) => {
                if (!pdfDoc) return;
                newPageNum = Math.max(1, Math.min(newPageNum, pdfDoc.numPages));
                if (pageNum !== newPageNum) {
                    pageNum = newPageNum;
                    document.getElementById('page-num').textContent = displayPageNumber(pageNum);
                    queueRenderPage(pageNum);
                }
            };

            function displayPageNumber(num) {
                if (filename === "Ekamra Purana.pdf" && document.referrer.includes("Upa-Puranas")) {
                    const offset = 4;
                    const romanNumerals = { '-3': 'I', '-2': 'II', '-1': 'III', '0': 'IV' };
                    const adjustedPageNum = num - offset;
                    return romanNumerals[adjustedPageNum] || (adjustedPageNum > 0 ? adjustedPageNum : '');
                }
                return num;
            }

            const updatePageNum = () => {
                const inputElement = document.getElementById('page-num');
                const newPageNum = parseInt(inputElement.textContent, 10);

                if (!isNaN(newPageNum)) {
                    const adjustedPageNum = (filename === "Ekamra Purana.pdf" && document.referrer.includes("Upa-Puranas"))
                        ? newPageNum + 4
                        : newPageNum;
                    updateAndRenderPage(adjustedPageNum);
                } else {
                    inputElement.textContent = displayPageNumber(pageNum);
                }
            };

            // =================================================================
            // MAIN LOGIC: Decide whether to load a single PDF or merge multiple
            // =================================================================
            if (filename && filename.includes(',')) {
                // --- MULTI-PART PDF MERGING LOGIC ---
                loadingMessage.textContent = 'Merging files, this may take some time...';

                async function mergePdfs(parts, baseDir) {
                    const { PDFDocument } = PDFLib;
                    const mergedPdf = await PDFDocument.create();
                    for (const part of parts) {
                        const trimmedPart = part.trim();
                        if (!trimmedPart) continue;
                        // The baseDir parameter tells us where to look for the files
                        const partUrl = `/DharmicData/${baseDir}/${trimmedPart}`;
                        console.log('Fetching part URL:', partUrl);
                        try {
                            const partBytes = await fetch(partUrl).then(res => res.arrayBuffer());
                            const partDoc = await PDFDocument.load(partBytes);
                            const copiedPages = await mergedPdf.copyPages(partDoc, partDoc.getPageIndices());
                            copiedPages.forEach(page => mergedPdf.addPage(page));
                        } catch (error) {
                            console.error(`Error processing PDF part "${partUrl}":`, error);
                        }
                    }
                    return await mergedPdf.save();
                }

                try {
                    const parts = filename.split(',');
                    const mergedPdfBytes = await mergePdfs(parts, dirParam); // Use the dir param from URL
                    pdfDoc = await pdfjsLib.getDocument({ data: mergedPdfBytes }).promise;
                    document.getElementById("page-count").textContent = pdfDoc.numPages;
                    loader.style.display = 'none';
                    loadingMessage.style.display = 'none';
                    renderPage(pageNum);
                } catch (err) {
                    console.error("Failed to load and merge PDFs:", err);
                    loader.style.display = 'none';
                    loadingMessage.textContent = 'Error loading book.';
                }

            } else {
                // SINGLE PDF LOADING LOGIC
                loadingMessage.textContent = 'The file may take some time to load...';
                let url;

                // ==========================================================
                // THE FIX IS HERE:
                // Prioritize the 'dir' parameter if it exists. This makes
                // the viewer truly generic and fixes the nested path issue.
                // ==========================================================
                if (dirParam) {
                    url = `/DharmicData/${dirParam}/${filename}`;
                } else {
                    // Fallback to the old referrer logic if 'dir' is not provided
                    const referrer = document.referrer;
                    const lowerCaseReferrer = referrer.toLowerCase();
                    const referrerMap = {
                        'upnishad': 'Upnishad', 'ramayanas': 'Ramayanas', 'upa-smritis': 'UpaSmritis',
                        'upapuranas': 'UpaPuranas', 'vedanga': 'Vedanga', 'aarati': 'Aartis',
                        'bhajan': 'Bhajan', 'swaminarayan-sect': 'Swaminarayan Sect', 'occult': 'Occult',
                        'upa-veda': 'Upa-Veda', 'agamas': 'Agamas'
                    };
                    let found = false;
                    for (const key in referrerMap) {
                        if (lowerCaseReferrer.includes(key)) {
                            url = `/DharmicData/${referrerMap[key]}/${filename}`;
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        console.error('Invalid referrer for single PDF:', referrer);
                        loadingMessage.textContent = 'Error: Could not determine file location.';
                        return;
                    }
                }

                console.log('Loading single PDF from URL:', url);

                pdfjsLib.getDocument(url).promise.then((pdfDoc_) => {
                    pdfDoc = pdfDoc_;
                    document.getElementById('page-count').textContent = (filename === "Ekamra Purana.pdf" && referrer.includes("Upa-Puranas"))
                        ? pdfDoc.numPages - 4
                        : pdfDoc.numPages;
                    loader.style.display = 'none';
                    loadingMessage.style.display = 'none';
                    renderPage(pageNum);
                }).catch((err) => {
                    console.error('Error loading single PDF:', err);
                    const div = document.createElement('div');
                    div.className = 'error';
                    div.textContent = `Error: ${err.message}`;
                    document.body.insertBefore(div, document.querySelector('.center-container'));
                    loader.style.display = 'none';
                    loadingMessage.style.display = 'none';
                });
            }


            // --- NAVIGATION EVENT LISTENERS (Remain Unchanged) ---
            window.addEventListener('keydown', function (e) {
                if (isEditing) {
                    if (e.key === 'Enter') {
                        isEditing = false;
                        updatePageNum();
                        e.preventDefault();
                    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                        e.preventDefault();
                    }
                } else {
                    if (e.key === 'ArrowUp' || e.key === 'ArrowLeft' || e.key === 'PageUp') {
                        e.preventDefault();
                        updateAndRenderPage(pageNum - 1);
                    } else if (e.key === 'ArrowDown' || e.key === 'ArrowRight' || e.key === 'PageDown') {
                        e.preventDefault();
                        updateAndRenderPage(pageNum + 1);
                    }
                }
            });

            document.getElementById('page-num').addEventListener('click', function () {
                isEditing = true;
                this.textContent = '';
            });

            document.getElementById('page-num').addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    isEditing = false;
                    updatePageNum();
                    e.preventDefault();
                }
            });

            window.addEventListener('wheel', function (e) {
                updateAndRenderPage(pageNum + (e.deltaY > 0 ? 1 : -1));
            });

            let touchStartY = 0, touchStartX = 0, isMultiTouch = false;
            window.addEventListener('touchstart', function (e) {
                isMultiTouch = e.touches.length > 1;
                if (!isMultiTouch) {
                    touchStartY = e.touches[0].clientY;
                    touchStartX = e.touches[0].clientX;
                }
            });

            window.addEventListener('touchend', function (e) {
                if (isMultiTouch) return;
                const touchEndY = e.changedTouches[0].clientY;
                const touchEndX = e.changedTouches[0].clientX;
                const deltaY = touchEndY - touchStartY;
                const deltaX = touchEndX - touchStartX;
                const thresholdY = window.innerHeight / 7.5;
                const thresholdX = window.innerWidth / 7.5;

                if (Math.abs(deltaY) > Math.abs(deltaX)) {
                    if (deltaY > thresholdY) updateAndRenderPage(pageNum - 1);
                    else if (deltaY < -thresholdY) updateAndRenderPage(pageNum + 1);
                } else {
                    if (deltaX > thresholdX) updateAndRenderPage(pageNum - 1);
                    else if (deltaX < -thresholdX) updateAndRenderPage(pageNum + 1);
                }
            });
        });
    </script>
</body>

</html>