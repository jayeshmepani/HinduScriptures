<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link rel="icon" type="image/x-icon" href="/download.png" />
  <script src="/js/pdf.min.js"></script>
  <script src="/js/pdf.worker.min.js"></script>
  <link rel="stylesheet" href="/css/pdfjs.css" />
  <title>Content</title>
</head>

<body>
  <div class="top-bar">
    <span class="page-info">
      Page
      <span id="page-num" contenteditable="true"></span>
      of <span id="page-count"></span>
    </span>
  </div>
  <div class="center-container" id="center-container">
    <div id="the-svg"></div>
    <div class="loader" id="loader"></div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const urlParams = new URLSearchParams(window.location.search);
      const filename = urlParams.get('filename');
      const section = urlParams.get('section');
      const loader = document.getElementById('loader');
      const container = document.querySelector("#the-svg");
      const svgCont = document.querySelector('#center-container');

      let pdfDoc = null, pageNum = 1, pageIsRendering = false, pageNumIsPending = null, isEditing = false;
      let containerWidth, containerHeight;

      let url;
      const referrer = document.referrer;
      const lowerCaseReferrer = referrer.toLowerCase();

      const categories = {
        'gitas': 'Gitas',
        'namavalis': 'Namavalis',
        'stotras': 'Stotras',
        'smritis': 'Smritis',
        'upa-smritis': 'UpaSmritis',
        'stutis': 'Stuti',
        'ashtakas': 'Ashtaka',
        'kavachas': 'Kavacha',
        'chalisas': 'Chalisa',
        'upapuranas': 'UpaPuranas',
        'vedanga': 'Vedanga',
        'upanga': 'Upanga',
        'swaminarayan-sect': 'Swaminarayan Sect',
        'agamas': 'Agamas',
        'occult': 'Occult',
        'upa-veda': 'Upa-Veda'
      };

      for (const key in categories) {
        if (lowerCaseReferrer.includes(key)) {
          let path = categories[key];
          if (section) {
            path = `${path}/${decodeURIComponent(section)}`;
          }
          url = `/DharmicData/${path}/${filename}`;
          break;
        }
      }

      if (!url) {
        console.error('Invalid referrer or unhandled category:', referrer);
        loader.style.display = 'none';
        document.querySelector('.center-container').innerHTML = `<div class="error">Could not determine file location.</div>`;
        return;
      }

      console.log('Fetching URL:', url);
      loader.style.display = 'block';
      const loadingMessage = document.createElement('div');
      loadingMessage.className = 'loading-message';
      loadingMessage.textContent = 'Please wait until load...';
      document.querySelector('.center-container').appendChild(loadingMessage);

      const applyScaling = () => {
        if (!container || !containerWidth || !containerHeight) return;
        const currentWidth = window.innerWidth;
        const svgElement = document.getElementById('the-svg');
        if (!svgElement) return;

        svgElement.style.overflowX = 'hidden';
        svgCont.style.overflowX = 'hidden';

        if (filename === 'Gopi Gita.pdf' && lowerCaseReferrer.includes('gitas')) {
          const slope = 20 / 3;
          const intercept = 66.666667;
          let scalingFactor;
          if (currentWidth < 300) { scalingFactor = 55; }
          else if (currentWidth > 460) { scalingFactor = 79; }
          else { scalingFactor = (currentWidth + intercept) / slope; }
          svgElement.style.transform = `scale(${scalingFactor / 100})`;
        } else if (lowerCaseReferrer.includes('stotras') || lowerCaseReferrer.includes('namavalis') || lowerCaseReferrer.includes('chalisas') || lowerCaseReferrer.includes('stutis') || lowerCaseReferrer.includes('ashtakas') || lowerCaseReferrer.includes('kavachas') || lowerCaseReferrer.includes('smritis') || lowerCaseReferrer.includes('upa-smritis') || lowerCaseReferrer.includes('swaminarayan-sect') || lowerCaseReferrer.includes('vedanga') || lowerCaseReferrer.includes('upanga') || lowerCaseReferrer.includes('upapuranas') || lowerCaseReferrer.includes('upa-veda') || lowerCaseReferrer.includes('agamas') || lowerCaseReferrer.includes('occult')) {
          if (currentWidth > 355 && currentWidth < 400) { svgElement.style.transform = 'scale(0.9)'; }
          else if (currentWidth <= 355) { svgElement.style.transform = 'scale(0.8)'; }
        } else {
          const containerWidthNum = parseFloat(containerWidth);
          if (containerWidthNum > currentWidth) {
            const scale = currentWidth / containerWidthNum;
            svgElement.style.transform = `scale(${scale})`;
          } else {
            svgElement.style.transform = 'scale(1)';
          }
        }
      };

      const renderPage = (num) => {
        pageIsRendering = true;
        pdfDoc.getPage(num).then((page) => {
          const viewport = page.getViewport({ scale: 1 });
          containerWidth = viewport.width + "px";
          containerHeight = viewport.height + "px";
          container.style.height = containerHeight;
          container.style.width = containerWidth;

          page.getOperatorList().then(opList => {
            const svgGfx = new pdfjsLib.SVGGraphics(page.commonObjs, page.objs);
            return svgGfx.getSVG(opList, viewport);
          })
            .then(function (svg) {
              const svgElements = svg.querySelectorAll('g[transform="translate(72 523.276)"]');
              if (svgElements.length > 2) {
                svgElements[svgElements.length - 1].remove();
              }

              svg.querySelectorAll('text[transform*="matrix(5 0 0 5 91 739.1732)"]').forEach(function (element) {
                element.remove();
              });

              svg.querySelectorAll('text[transform*="matrix(5 0 0 5 91 738.1732)"]').forEach(function (element) {
                element.remove();
              });

              svg.querySelectorAll('text[transform*="matrix(5 0 0 5 417.6915 738.5332)"]').forEach(function (element) {
                element.remove();
              });

              svg.querySelectorAll('text[transform*="matrix(5 0 0 5 417.6915 739.5332)"]').forEach(function (element) {
                element.remove();
              });

              container.innerHTML = '';
              container.appendChild(svg);
              applyScaling();
              window.addEventListener('resize', applyScaling);
              pageIsRendering = false;
              if (pageNumIsPending !== null) {
                renderPage(pageNumIsPending);
                pageNumIsPending = null;
              }
              document.getElementById("page-num").textContent = num;
            });
        });
      };

      const queueRenderPage = num => {
        if (pageIsRendering) {
          pageNumIsPending = num;
        } else {
          renderPage(num);
        }
      };

      pdfjsLib.getDocument(url).promise.then((pdfDoc_) => {
        pdfDoc = pdfDoc_;
        document.querySelector("#page-count").textContent = pdfDoc.numPages;
        loader.style.display = 'none';
        loadingMessage.remove();
        renderPage(pageNum);
      }).catch((err) => {
        console.error(err);
        loader.style.display = 'none';
        loadingMessage.remove();
        const div = document.createElement("div");
        div.className = "error";
        div.textContent = `Error: ${err.message}. Failed to load PDF from ${url}`;
        document.body.insertBefore(div, container);
        document.querySelector(".top-bar").style.display = "none";
      });

      const updateAndRenderPage = (newPageNum) => {
        newPageNum = Math.max(1, Math.min(newPageNum, pdfDoc.numPages));

        if (pageNum !== newPageNum) {
          pageNum = newPageNum;
          document.getElementById("page-num").textContent = pageNum;
          queueRenderPage(pageNum);
        }
      };

      window.addEventListener("wheel", function (e) {
        const sensitivity = 0.3;
        const deltaY = e.deltaY * sensitivity;

        if (deltaY > 0) {
          updateAndRenderPage(pageNum + 1);
        } else {
          updateAndRenderPage(pageNum - 1);
        }
      });

      let touchStartY = 0;
      let touchStartX = 0;
      let isMultiTouch = false;

      window.addEventListener('touchstart', function (e) {
        if (e.touches.length > 1) {
          isMultiTouch = true;
          return;
        }
        isMultiTouch = false;
        touchStartY = e.touches[0].clientY;
        touchStartX = e.touches[0].clientX;
      });

      window.addEventListener('touchend', function (e) {
        if (isMultiTouch) return;
        const touchEndY = e.changedTouches[0].clientY;
        const touchEndX = e.changedTouches[0].clientX;
        const deltaY = touchEndY - touchStartY;
        const deltaX = touchEndX - touchStartX;

        const touchSensitivity = 7.5;
        const deltaThreshold = window.innerHeight / touchSensitivity;
        const deltaThresholdX = window.innerWidth / touchSensitivity;

        if (Math.abs(deltaY) > Math.abs(deltaX)) {
          if (deltaY > deltaThreshold) {
            updateAndRenderPage(pageNum - 1);
          } else if (deltaY < -deltaThreshold) {
            updateAndRenderPage(pageNum + 1);
          }
        } else {
          if (deltaX > deltaThresholdX) {
            updateAndRenderPage(pageNum - 1);
          } else if (deltaX < -deltaThresholdX) {
            updateAndRenderPage(pageNum + 1);
          }
        }
      });

      window.addEventListener('touchmove', function (e) {
        if (e.touches.length > 1) {
          isMultiTouch = true;
        }
      });

      window.addEventListener("keydown", function (e) {
        if (isEditing) {
          if (e.key === "Enter") {
            isEditing = false;
            updatePageNum();
            e.preventDefault();
          } else if (e.key === "ArrowLeft" || e.key === "ArrowRight") {
            e.preventDefault();
          }
        } else {
          if (e.key === "ArrowUp" || e.key === "ArrowLeft" || e.key === "PageUp") {
            e.preventDefault();
            updateAndRenderPage(pageNum - 1);
          } else if (e.key === "ArrowDown" || e.key === "ArrowRight" || e.key === "PageDown") {
            e.preventDefault();
            updateAndRenderPage(pageNum + 1);
          }
        }
      });

      const updatePageNum = () => {
        const inputElement = document.getElementById("page-num");
        const newPageNum = parseInt(inputElement.textContent, 10);

        if (!isNaN(newPageNum)) {
          updateAndRenderPage(newPageNum);
        } else {
          inputElement.textContent = pageNum;
        }
        isEditing = false;
      };

      // Show Prev Page
      const showPrevPage = () => {
        updateAndRenderPage(pageNum - 1);
      };

      // Show Next Page
      const showNextPage = () => {
        updateAndRenderPage(pageNum + 1);
      };

      document.getElementById("page-num").addEventListener("click", function () {
        isEditing = true;
        this.textContent = "";
      });

      // Only process on blur or Enter key, NOT on input
      document.getElementById("page-num").addEventListener("blur", function () {
        if (isEditing) {
          updatePageNum();
        }
      });

      document.getElementById("page-num").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          isEditing = false;
          updatePageNum();
          this.blur();
          e.preventDefault();
        } else if (e.key === "Escape") {
          isEditing = false;
          this.textContent = pageNum;
          this.blur();
          e.preventDefault();
        }
      });

      // Apply scaling when window is resized
      window.addEventListener('resize', applyScaling);

      window.addEventListener('load', () => {
        applyScaling();
      });

    }).catch(error => {
      console.error('Error loading PDF:', error);
    });
  </script>
</body>

</html>