<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link rel="stylesheet" href="/css/style.css">
  <link rel="icon" type="image/x-icon" href="/download.png">
  <title>Content</title>
  <style>
    #p {
      font-size: 1.3rem;
      color: yellow;
    }

    div#jsonContent div {
      display: flex;
      flex-direction: column;
      text-align: left;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="search-results">
      <div id="jsonContent">
        <br>
        <br>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const urlParams = new URLSearchParams(window.location.search);
      const filename = urlParams.get('filename');
      const section = urlParams.get('section'); // For nested structures

      let url;
      const referrer = document.referrer;
      const lowerCaseReferrer = referrer.toLowerCase(); // Use lowercase for case-insensitive matching

      // Using a map for cleaner, more maintainable logic
      const referrerMap = {
        'gitas': `/DharmicData/Gitas/${filename}`,
        'dattpurana': `/DharmicData/UpaPuranas/Datt Purana/${filename}`,
        'stotras': `/DharmicData/Stotras/${filename}`,
        'harivanshapurana': `/DharmicData/UpaPuranas/Harivansha Purana/${filename}`,
        'naradiyapurana': `/DharmicData/UpaPuranas/Naradiya Purana/${filename}`,
        'vishnudharmottarpurana': `/DharmicData/UpaPuranas/Vishnudharmottar Purana/${filename}`,
        'kalikapurana': `/DharmicData/UpaPuranas/Kalika Purana/${filename}`,
        'mallapurana': `/DharmicData/UpaPuranas/Malla Purana/${filename}`,
        'mudgalapurana': `/DharmicData/UpaPuranas/Mudgala Purana/${filename}`,
        'shivadharmapurana': `/DharmicData/UpaPuranas/Shivadharma Purana/${filename}`,
        'srimaddevibhagwatpurana': `/DharmicData/UpaPuranas/Srimad Devi Bhagwat Purana/${filename}`,
        'chalisas': `/DharmicData/Chalisa/${filename}`,
        'ramcharitmanas': `/DharmicData/Ramayanas/Ramcharitmanas/${filename}`,
        'aarati': `/DharmicData/Aartis/${filename}`,
        // --- NEW LOGIC FOR ADDED MENUS ---
        'agamas': `/DharmicData/Agamas/${filename}`,
        'garga-samhita': `/DharmicData/Garga Samhita/${decodeURIComponent(section)}/${filename}`,
        'occult': `/DharmicData/Occult/${filename}`
      };

      // Find the correct URL from the map
      for (const key in referrerMap) {
        if (lowerCaseReferrer.includes(key)) {
          url = referrerMap[key];
          break;
        }
      }

      if (url) {
        console.log('Fetching URL:', url);

        fetch(url)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Failed to fetch JSON file: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('JSON Data:', data);
            const jsonContentDiv = document.getElementById('jsonContent');

            if (Array.isArray(data) && data.length > 0) {
              // Logic for rendering JSON with a "content" property
              if (data[0].content) {
                data.forEach(entry => {
                  const entryDiv = document.createElement('div');
                  entryDiv.innerHTML = `
                      <div style="display: grid; align-items: center; justify-content: center;">
                        <p style="color: yellow; font-weight: bold;">${entry.kaand || ''}</p>
                        <p style="color: white; font-weight: bold;">${entry.type || ''}</p>
                        <p style="color: orange;">${entry.content.replace(/\n/g, '<br>').trim()}</p>
                        <br><br>
                      </div>`;
                  jsonContentDiv.appendChild(entryDiv);
                });
                // Logic for rendering JSON with a "text" property
              } else if (data[0].text) {
                const entryDiv = document.createElement('div');
                entryDiv.id = 'p';
                entryDiv.style.textAlign = 'center';
                // Sort data numerically by filename if available
                const sortedData = data.sort((a, b) => {
                  const numA = parseInt(a.filename, 10);
                  const numB = parseInt(b.filename, 10);
                  return (isNaN(numA) || isNaN(numB)) ? 0 : numA - numB;
                });
                sortedData.forEach(entry => {
                  entryDiv.innerHTML += `<div>${entry.text.replace(/\n/g, ' <br/> ').trim()}</div><br><br>`;
                });
                jsonContentDiv.appendChild(entryDiv);
              } else {
                console.error('Error: Unexpected JSON structure.');
                jsonContentDiv.innerHTML = `<p style="color:red; text-align:center;">Could not display content due to unexpected JSON structure.</p>`;
              }
            } else {
              console.error(`Error: Data is not a valid array or is empty.`);
              jsonContentDiv.innerHTML = `<p style="color:red; text-align:center;">No content found in the file.</p>`;
            }
          })
          .catch(error => {
            console.error(`Error fetching or displaying JSON file ${filename}:`, error);
            document.getElementById('jsonContent').innerHTML = `<p style="color:red; text-align:center;">Could not load content. Please check the console for errors.</p>`;
          });
      } else {
        console.error('Invalid or unhandled referrer:', referrer);
        document.getElementById('jsonContent').innerHTML = `<p style="color:red; text-align:center;">Could not determine the correct file path. Invalid referrer.</p>`;
      }
    });
  </script>
</body>

</html>